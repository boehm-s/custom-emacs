exports.up = function(knex, Promise) {
    return Promise.all([
	knex.raw(`
                 DROP FUNCTION IF EXISTS is_coach_available(INTEGER, timestamp);
                 CREATE OR REPLACE FUNCTION is_coach_available(coach_id INTEGER, hour_start_session timestamp)
                 RETURNS VARCHAR AS
                 $BODY$
                     DECLARE
                         res1 VARCHAR(100);
                         res2 VARCHAR(100);
                         res VARCHAR(100);
                 	hour_end_session timestamp;
                 	starting_hour timestamp;
                 	morning_hour timestamp;
                 	noon_hour timestamp;
                 	afternoon_hour timestamp;
                 	evening_hour timestamp;
                 	morning_coach BOOLEAN;
                 	noon_coach BOOLEAN;
                 	afternoon_coach BOOLEAN;
                 	evening_coach BOOLEAN;
                     BEGIN
                 	SELECT 'no' into res1;
                 	SELECT hour_start_session + (60 * interval '1 minute') into hour_end_session;
                         SELECT hour_start_session::date + time '06:00' into starting_hour;
                         SELECT hour_start_session::date + time '10:00' into morning_hour;
                         SELECT hour_start_session::date + time '14:00' into noon_hour;
                         SELECT hour_start_session::date + time '18:00' into afternoon_hour;
                         SELECT hour_start_session::date + time '22:00' into evening_hour;
                         SELECT "availableMorning" 	FROM coach_availability WHERE "coachId" = coach_id AND day = hour_start_session::date into morning_coach;
                         SELECT "availableNoon"    	FROM coach_availability WHERE "coachId" = coach_id AND day = hour_start_session::date into noon_coach;
                         SELECT "availableAfternoon" 	FROM coach_availability WHERE "coachId" = coach_id AND day = hour_start_session::date into afternoon_coach;
                         SELECT "availableEvening" 	FROM coach_availability WHERE "coachId" = coach_id AND day = hour_start_session::date into evening_coach;

                         SELECT
                             CASE
                 		/* Pendant l'horaire du matin */
                 	        WHEN ((hour_start_session BETWEEN starting_hour AND morning_hour) AND (hour_end_session BETWEEN starting_hour AND morning_hour))
                 	    	THEN
                 		    CASE
                 			WHEN morning_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 		/* Entre le matin et le midi */
                 	        WHEN ((hour_start_session BETWEEN starting_hour AND morning_hour) AND (hour_end_session BETWEEN morning_hour AND noon_hour))
                 	    	THEN
                 		    CASE
                 			WHEN morning_coach = true AND noon_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 		/* Pendant l'horaire du midi */
                 		WHEN ((hour_start_session BETWEEN morning_hour AND noon_hour) AND (hour_end_session BETWEEN morning_hour AND noon_hour))
                 	    	THEN
                 		    CASE
                 			WHEN noon_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 		/* Entre l'horaire du midi et de l'apres midi */
                 		WHEN ((hour_start_session BETWEEN morning_hour AND noon_hour) AND (hour_end_session BETWEEN noon_hour AND afternoon_hour))
                 	    	THEN
                 		    CASE
                 			WHEN noon_coach = true AND afternoon_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 		/* Pendant l'horaire du soir */
                 		WHEN ((hour_start_session BETWEEN noon_hour AND afternoon_hour) AND (hour_end_session BETWEEN noon_hour AND afternoon_hour))
                 	    	THEN
                 		    CASE
                 			WHEN afternoon_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 		/* Entre l'horaire du soir et l'horaire de nuit */
                 		WHEN ((hour_start_session BETWEEN noon_hour AND afternoon_hour) AND (hour_end_session BETWEEN afternoon_hour AND evening_hour))
                 	    	THEN
                 		    CASE
                 			WHEN afternoon_coach = true AND evening_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 		/* Pendant l'horaire de nuit */
                 		WHEN ((hour_start_session BETWEEN afternoon_hour AND evening_hour) AND (hour_end_session BETWEEN afternoon_hour AND evening_hour))
                 	    	THEN
                 		    CASE
                 			WHEN evening_coach = true THEN 'yes' ELSE 'no'
                 		    END
                 	    END
                 	FROM coach_availability
                         WHERE "coachId" = coach_id
                         AND day = hour_start_session::date into res1;

                 	SELECT
                 	    CASE
                 		WHEN EXISTS (
                 		     	    SELECT * FROM bookings
                 			    WHERE "coachId" = coach_id
                 			    AND ((hour_start_session - (30 * interval '1 minute')) BETWEEN "sessionStart" AND  ("sessionStart" + (60 * interval '1 minute'))
                 			    	OR (hour_end_session + (30 * interval '1 minute') BETWEEN "sessionStart" AND  ("sessionStart" + (60 * interval '1 minute')))
                 			    ))
                 		THEN 'no'
                 		ELSE 'yes'
                 	    END
                 	into res2;

                 	SELECT CASE WHEN res1 LIKE 'yes' AND res2 LIKE 'yes' THEN 'yes' ELSE 'no' END into res;

                         RETURN res;
                     END
                 $BODY$
                 LANGUAGE plpgsql; `)
    ]);
};

exports.down = function(knex, Promise) {
    return Promise.all([
	knex.raw(`DROP FUNCTION IF EXISTS is_coach_available(INTEGER, timestamp);`)
    ]);
};
