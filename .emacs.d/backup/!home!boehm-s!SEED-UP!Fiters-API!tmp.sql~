CREATE OR REPLACE FUNCTION is_coach_available(coach_id INTEGER)
RETURNS BOOLEAN AS
$BODY$
    DECLARE
        res BOOLEAN;
	desired_hour timestamp;
	starting_hour timestamp;
	morning_hour timestamp;
	noon_hour timestamp;
	afternoon_hour timestamp;
	evening_hour timestamp;
	morning_coach BOOLEAN;
	noon_coach BOOLEAN;
	afternoon_coach BOOLEAN;
	evening_coach BOOLEAN;
    BEGIN
        SELECT now() AT TIME ZONE 'Europe/Paris' + (30 * interval '1 minute') into desired_hour;
        SELECT current_date AT TIME ZONE 'Europe/Paris' + time '06:00' into starting_hour;
        SELECT current_date AT TIME ZONE 'Europe/Paris' + time '10:00' into morning_hour;
        SELECT current_date AT TIME ZONE 'Europe/Paris' + time '14:00' into noon_hour;
        SELECT current_date AT TIME ZONE 'Europe/Paris' + time '18:00' into afternoon_hour;
        SELECT current_date AT TIME ZONE 'Europe/Paris' + time '22:00' into evening_hour;
        SELECT "availableMorning" 	FROM coach_availability WHERE "coachId" = coach_id AND day = current_date into morning_coach;
        SELECT "availableNoon"    	FROM coach_availability WHERE "coachId" = coach_id AND day = current_date into noon_coach;
        SELECT "availableAfternoon" 	FROM coach_availability WHERE "coachId" = coach_id AND day = current_date into afternoon_coach;
        SELECT "availableEvening" 	FROM coach_availability WHERE "coachId" = coach_id AND day = current_date into evening_coach;

        SELECT
            CASE
	        WHEN desired_hour BETWEEN starting_hour AND morning_hour
	    	THEN
		    CASE
			WHEN morning_coach = true THEN SELECT true into res;
		    END
		WHEN desired_hour BETWEEN morning_hour AND noon_hour
	    	THEN
		    CASE
			WHEN noon_coach = true THEN SELECT true into res;
		    END
		WHEN desired_hour BETWEEN noon_hour AND afternoon_hour
	    	THEN
		    CASE
			WHEN afternoon_coach = true THEN SELECT true into res;
		    END
		WHEN desired_hour BETWEEN afternoon_hour AND evening_hour
	    	THEN
		    CASE
			WHEN evening_coach = true THEN SELECT true into res;
		    END
	    END
	FROM coach_availability
        WHERE "coachId" = 19
        AND day = current_date;

        RETURN SELECT res;
    END
$BODY$
LANGUAGE plpgsql;
